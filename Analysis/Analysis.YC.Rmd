---
title: "NBA Multilevel Model"
author: "Yuka Chen"
date: "`r Sys.Date()`"
output: pdf_document
---

# Loading libraries
```{r include=FALSE}
library(tidyverse)
library(ISLR)
library(tidymodels)
library(DAAG)
library(party)
library(rpart)
library(rpart.plot)
library(mlbench)
library(caret)
library(pROC)
library(tree)
library(broom)
library(kableExtra)
library(MASS)
library(arm)
library(leaps)
library(ggthemr)
library(fastDummies)

```

# Loading data
```{r include=FALSE}
new.data<- read_rds("../Data/cases.after2010.rds")

FACTOR <- c("PERSONTYPE", "TIME_PERIOD", "WARD", "FATAL", "SPEEDING_INVOLVED","INVEHICLETYPE")
new.data[,FACTOR] <- lapply(new.data[,FACTOR] , factor)

glimpse(new.data)
```


```{r include=FALSE}
map_df(new.data, ~class(.))
```

#Logistic Regression with the full data set

```{r}

full.model <- glm(FATAL ~ ., data = new.data, family = "binomial")
display(full.model)
```

#Logistic Regression with the partial data set

#Stepwise
```{r}
new.data |> 
  slice_sample(n = 5000) -> sample_data

# Fit a logistic regression model to your data
model <- glm(FATAL ~ ., data = sample_data, family = "binomial", maxit = 100)
# Perform a stepwise regression
step_model <- stepAIC(model, direction = "both")
```


```{r}
# Print the summary of the stepwise model
summary(step_model)

tidy(step_model) |> 
  dplyr::arrange(p.value) |> 
    knitr::kable("latex", booktabs = T) %>%
  kable_styling() %>%
  save_kable(file = "../Output/stepwise.output.png",
             zoom = 1.5,
             bs_theme = "Sandstone")
```
# Initial Logit



```{r}
logit_summary <- glm(FATAL ~ TIME_PERIOD + MONTH + SPEEDING_INVOLVED + AGE + WARD + PERSONTYPE, data = new.data, family = "binomial")
summary(logit_summary)
tidy(logit_summary)
```

## Summary Table
```{r}
sum.table <- tidy(logit_summary) |> 
  mutate(p.value = round(p.value, digits = 5),
         estimate = round(estimate, digits = 5)) |> 
  dplyr::arrange(p.value) |> 
  filter(p.value < 0.1) |> 
    knitr::kable("latex", booktabs = T) %>%
  kable_styling() %>%
  save_kable(file = "../Output/initial.table.png",
             zoom = 1.5,
             bs_theme = "Sandstone")

```

```{r}
glance(fatal_logit) |> 
  knitr::kable("latex", booktabs = T) %>%
  kable_styling() %>%
  save_kable(file = "glance3.png",
             zoom = 1.5,
             bs_theme = "Sandstone")
```

```{r}
logout1 <- augment(fatal_logit)
```


# Ridge
```{r}
library(MASS)
# include:false
rr <-  lm.ridge(FATAL ~ ., lambda=seq(0,100,1), data = new.data)
head(rr$coef, n=6)
```

```{r}
broom::tidy(rr)
plot(rr)
```

```{r}
MASS::select(rr)
```

```{r}
ggthemr("fresh")

ggplot(broom::tidy(rr), 
       aes(x = lambda, y = GCV)) +
  geom_line() +
  geom_vline(xintercept = broom::tidy(rr)$lambda[which.min(broom::tidy(rr)$GCV)],
             color = "red", lty = 2)
```



```{r}

library(MASS)
# include:false
rr <-  lm.ridge(FATAL ~ ., lambda=seq(390,425,1), data = new.data)
head(rr$coef, n=6)
MASS::select(rr)
ggplot(broom::tidy(rr), 
       aes(x = lambda, y = GCV)) +
  geom_line() +
  geom_vline(xintercept = broom::tidy(rr)$lambda[which.min(broom::tidy(rr)$GCV)],
             color = "red", lty = 2)
```


```{r}
reg <- glm(FATAL ~ ., data = new.data) 
x <- model.matrix(reg)
dim(x)
y <- new.data$FATAL

rr <- glmnet(x, y, alpha = 0)
```
```{r}
plot(rr, label = TRUE)
plot(rr, xvar = "lambda", label = TRUE)
```
```{r}
set.seed(123)
rr_cv <- cv.glmnet(x, y, alpha=0)
rr_cv
```
```{r}
plot(rr_cv)
```
```{r}
coef(rr_cv)
coef(rr_cv, s = "lambda.min") 
coef(rr_cv) |> as.matrix()
sum(coef(rr_cv)^2) - sum(coef(rr_cv, s = "lambda.min")^2)
rr_cv$cvm[rr_cv$index[2]] - rr_cv$cvm[rr_cv$index[1]]

```

```{r}
library(glmnet)
reg <- lm(FATAL ~ ., data = new.data) 
fit <- glmnet(x, y, family = "binomial", alpha = 1)

x <- model.matrix(reg)
dim(x)
```





# KNN Classification

```{r}
library(tidymodels)
data_split <- initial_split(new.data, prop = 2/3)
data_train <- training(data_split)
data_test <- testing(data_split)
```

```{r}
cl = data_train$FATAL  # Our training set y
knn(data_train, data_test, cl, k = 10) #same as before
knn(train, test, cl, k = 3) # different than before
```

```{r}

knnPredict <- predict(knnFit,newdata = DC_Test )
#Get the confusion matrix to see accuracy value and other parameter values
confusionMatrix(knnPredict, DC_Test$FATAL )
```


```{r}
#Data Spilt for random trees 
set.seed(1234)

data_split <- initial_split(new.data, prop = 0.7)

DC_Train <- training(data_split)
DC_Test <- testing(data_split)

```

```{r}
#Tree Classification
tree <- rpart(FATAL ~., data = DC_Train)
rpart.plot(tree)

#Not sure how to make this bigger
```

```{r}
printcp(tree)

#Classification tree:
rpart(formula = FATAL ~ ., data = DC_Train)

plotcp(tree)

```

```{r}
#Model selction using the minimum CP 
tree <- rpart(FATAL ~., data = DC_Train,cp=0.010000)
```

```{r}
#Model Accuray 
p <- predict(tree, DC_Test, type = 'class')
confusionMatrix (p, DC_Test$FATAL, positive = 'Y')
```

# Street Lights and Cases

```{r}
lights.accident<- read_rds("../Data/lights.accident.rds")

p1 <- lights.accident |> 
  ggplot(aes(x = s.lights, y = actd.cases))+
  geom_point()+
  geom_smooth(formula = 'y ~ x',method = 'loess')+
  labs(x = "",
       y = "Numbers of Street Lights",
       title = "Numbers of Accident during 5 PM - 6 AM ")

p2 <- lights.accident |> 
  ggplot(aes(x = s.lights, y = actd.cases, color = WARD))+
  geom_point()+
  geom_smooth(formula = 'y ~ x',method = 'loess')+
  theme(legend.position = "bottom")+
   labs(x = "Numbers of Accident",
       y = "Numbers of Street Lights", 
       title = "Categorized by Ward")+
  theme(plot.title = element_text(hjust = 0.5))
ggthemr("fresh")


grid.arrange(p1, p2, nrow=2)


```

```{r}
lights.accident.lm <- lm(actd.cases ~ s.lights, data = lights.accident)
tidy(summary(lights.accident.lm)) |> 
  knitr::kable("latex", booktabs = T) %>%
  kable_styling() %>%
  save_kable(file = "../Output/lights.accident.lm.png",
             zoom = 1.5,
             bs_theme = "Sandstone")
```
# Plot

```{r}
ggthemr("fresh")
df_dc3 |> 
  ggplot(aes(x = AGE))+
  geom_histogram(bins = 30)+
  labs(x = "Age", y = "Numbers of Drivers" ,
       title = "Distribution of Drivers by Age")+
  theme(plot.title = element_text(hjust = 0.5))
```

